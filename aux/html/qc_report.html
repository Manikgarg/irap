<% brew::brew(get.path2template("page.header")) %>

<%
library(xtable)
dummy.data <- function(n=200) {
  NSAMPLES <- n
  a <- rep(c(100,10000,100000,100000,1000000),NSAMPLES)
  l <- paste("lib",seq(1,NSAMPLES))
  m <- t(matrix(a,nrow=5))
  rownames(m) <- l
  #rownames(m) <- c("Reads4","Reads3","Reads2","Reads1","Reads0")
  m <- as.data.frame(m)
  m$Lib <- as.factor(l)
  colnames(m) <- c("Passed", "Unpaired", "Ns", "Contamination","Quality","Lib")
  return(m)
}
#bp.data<-dummy.data()
#bp.data.orig<-bp.data
#df<-bp.data.orig[seq(1,2),]
#df<-bp.data.orig[seq(1,5),]
#df<-bp.data.orig[seq(1,10),]
#df<-bp.data.orig[seq(1,15),]
#df<-bp.data.orig[seq(1,25),]
#df<-bp.data.orig
%>
  
<%# Comment -- wrap up everything in a div %>
<DIV name='qc_res'>
<H1>QC Report</H1>

<H2 class="section">Reads passed QC</H2>

<H3><%=irap.ctr("Table")%></H3>
<DIV class="table_wrapper">
<%
# anchor: qc_sum_table
table2.rows <- c("reads","length","median.base.qual","mean.base.qual","sd.base.qual","GC")
rownames(etdf)
table2 <- etdf[table2.rows,]
rownames(table2) <- c("Reads","Read Length","Median quality","Mean quality","Quality SD","GC%")
xt <- xtable(table2,
             caption="",
             label="qc_sum_table")

html <- print.xtable(file="/dev/null",
                     xt,
                     type="html",
                     sanitize.text.function=function(x) {x},
                     include.colnames=TRUE,
                     include.rownames=TRUE,
                     html.table.attributes = "")

irap.output.html(html, "The following table shows information, per
                 library, about the data used in the later steps of
                 the analysis. The following information per library
                 is presented: median, mean and standard deviation
                 of <a href=\"http://en.wikipedia.org/wiki/Phred_quality_score\"
                 target='_top'>Phred quality scores</a>,GC content,
                 number of reads and read length. The first three
                 columns provide the median, mean and standard
                 deviation of the values observed on all libraries.")

%>
</DIV>
<DIV> <%=qc.tsv.download.html%></DIV>


<H2 class="section">QC Filtering Summary<A NAME='plot'/></H2>

<H3 class="section"><%=irap.ctr("Figure")%></H3>
<%
file <- "read_filtering_plot.png"
#filepath <- "/tmp"
filepath <- paste(out.dir,sep="")
n <- length(rownames(df))
#df<-t(bp.data)
nlibs<-nrow(df)
width=max(400,10*nlibs)
if (conf.is.qc.enabled(conf)) {
  html <- gen.plot2report(filename=file,
                          dir=filepath,
                          bg="white",
                          width=width,
                          height=400,
                          html=TRUE,
                          ps=TRUE,
                          caption="",
                          to.plot= function() {
                            gen.qc.plot(df)
                          }
                          )

  irap.output.html(html$html,"Number of reads per library that passed the filtering process and that were filtered out because of quality, contamination, having uncalled bases (Ns), unpaired reads (only applicable to paired-end libraries).")
} else {
  irap.output.html("<p>Filtering disabled.</p>")
}
	  
%>

<!--<H3 class="section">QC Filtering Summary Table</H3>-->
<H3><%=irap.ctr("Table")%></H3>
<DIV class="table_wrapper">
<%

if (conf.is.qc.enabled(conf)) {
   xt <- xtable(out.table1,
                caption="",
                label="qc_filt_table")
   
   html <- print.xtable(xt,
                        file="/dev/null",
                        type="html",
                        sanitize.text.function=function(x) {x}, include.colnames=TRUE,
                        include.rownames=TRUE, html.table.attributes = "")
   irap.output.html(html,
                    "Number of reads per library that passed the filtering process and that were filtered out because of quality, contamination, having uncalled bases (Ns), unpaired reads (only applicable to paired-end libraries). The first three columns have the median, mean and standard deviation values observed across all libraries. QR links: FastQC reports per library for the initially provided data and for the data that passed the filter.The quality plots row allows to compare the quality score distribution over all sequences and bases before and after filtering.")
   } else {
     irap.output.html("<p>Filtering disabled.</p>")
   }

%>
</DIV>

</DIV>

<% brew::brew(get.path2template("page.footer")) %>

