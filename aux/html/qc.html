<% brew::brew(get.path2template("page.header")) %>

<%
source(paste(IRAP.DIR,"aux/R","irap_misc.R",sep="/"))

df<-raw.summary.dataframe(pe,se)
legend <- c("Passed", "Unpaired", "Ns", "Contamination","Quality")
#cols <- rainbow(length(legend))
cols <- c("green","yellow","purple","blue","red")

bp.data <- t(as.matrix(df[,c("Reads4","Reads3","Reads2","Reads1","Reads0")]))
colnames(bp.data) <- as.character(df[,c("Lib")])
rownames(bp.data) <- legend
nlibs <- length(colnames(bp.data))
cex <- NULL

# cols=colors
# bp.data - matrix with the number of reads in the end of each stage of the filtering process
qc.barplot<-function(bp.data,cols) {
  n <- length(colnames(bp.data))
  if ( n>10 ) { cex <- 0.6 } else { cex=0.5}  
  bp <- barplot( bp.data, beside = FALSE, col=cols, ylab="Number of reads", las=2 , cex.axis=cex, cex.names=0.8)
  par( xpd=NA )
  legend( "bottomright", legend=legend, fill=cols,horiz=TRUE, cex=0.7)
  for( i in c(1:length(colnames(bp.data))) ) {
    total <- sum(bp.data[,i])
    f <- c()
    y <- c()
    f[1] <- round(bp.data[1,i]*100/total)
    y[1] <- bp.data[1,i]
    f[2] <- round(bp.data[2,i]*100/total)
    y[2] <- sum(bp.data[c(1:2),i])  
    f[3] <- round(bp.data[3,i]*100/total)
    y[3] <- sum(bp.data[c(1:3),i])
    f[4] <- round(bp.data[4,i]*100/total)
    y[4] <- sum(bp.data[c(1:4),i])
    f[5] <- round(bp.data[5,i]*100/total)
    y[5] <- sum(bp.data[c(1:5),i])
    for( r in c(1:5) ){
      if (f[r]>0.01) {
        #pinfo(f[r])
        legend( bp[i], y[r]-bp.data[r,i]/2, paste("~",f[r], "%", sep=""), bty="n", xjust=0.5, yjust=0.5)      
      }
    }
  }
}
%>

<!-- Main plot -->
<H1>QC Report<A NAME='plot'/></H1>
<%
width=(480*round(0.5+nlibs/6/2,0))
file <- "read_filtering_plot.png"

p <- gen.plot2report(filename=paste(file,sep=""),
                       width=width
                       height=600,
                       caption="Read Filtering",
                       to.plot=function() {
                         qc.barplot<-function(bp.data,cols)
                       }
                       ) 
 cat(p$html)
%>
  
<!-- Table -->
<A NAME='sum'/>

<%# Comment -- wrap up everything in a div - end %>  
<!--</DIV>-->
<% brew::brew(get.path2template("page.footer")) %>

